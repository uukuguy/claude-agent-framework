# UV Package Management and Build Guide

This guide covers package management and building with UV for Claude Agent Framework.

## Quick Start

### Install UV

UV is a modern Python package manager. Install it with:

```bash
# Option 1: Using the installer (recommended)
curl -LsSf https://astral.sh/uv/install.sh | sh

# Option 2: Using pip
pip install uv

# Option 3: Using Homebrew (macOS)
brew install uv
```

Verify installation:
```bash
uv --version
```

### Initial Setup

```bash
# Sync dependencies
make sync

# Or manually
uv sync

# Install package in development mode
make dev

# Or manually
uv sync --all-groups
```

## UV Commands

### Dependency Management

```bash
# Sync all dependencies (creates .venv and uv.lock)
uv sync

# Sync with all optional groups (includes dev dependencies)
uv sync --all-groups

# Add a new dependency
uv add package-name

# Add a development dependency
uv add --group dev package-name

# Remove a dependency
uv remove package-name

# Update dependencies
uv pip install --upgrade package-name

# Show dependency tree
uv tree
```

### Running Python

```bash
# Run Python in the project environment
uv run python script.py

# Run a specific command in the environment
uv run pytest

# Install and run a package
uv run --with some-tool some-tool-command
```

### Virtual Environment

```bash
# Create/activate environment
. .venv/bin/activate  # Unix/macOS
.venv\Scripts\activate  # Windows

# Show environment location
uv venv --dir
```

## Building and Publishing

### Build Distributions

```bash
# Build wheel and source distributions
make build

# Clean and rebuild
make build-clean

# Or manually
python scripts/build_and_publish.py build
```

### Publish to PyPI

#### TestPyPI (Testing)

```bash
# Publish to TestPyPI
make publish-test

# Or manually
python scripts/build_and_publish.py publish --test
```

Test installation:
```bash
pip install -i https://test.pypi.org/simple/ claude-agent-framework
```

#### PyPI (Production)

```bash
# Publish to PyPI
make publish-prod

# Or manually
python scripts/build_and_publish.py publish --prod
```

### Build Script Commands

The `scripts/build_and_publish.py` script provides:

```bash
# Sync dependencies
python scripts/build_and_publish.py sync

# Build distributions
python scripts/build_and_publish.py build

# Clean old builds
python scripts/build_and_publish.py clean

# Publish to TestPyPI
python scripts/build_and_publish.py publish --test

# Publish to PyPI
python scripts/build_and_publish.py publish --prod

# Check setup
python scripts/build_and_publish.py check

# Show version
python scripts/build_and_publish.py version
```

## Project Structure

```
claude_agent_framework/
├── pyproject.toml        # Project configuration and dependencies
├── uv.lock              # Locked dependencies (generated by uv sync)
├── .venv/               # Virtual environment (created by uv)
├── .gitignore           # Excludes uv.lock (can be committed or not)
└── scripts/
    └── build_and_publish.py  # Build and publish script
```

## PyPI Authentication

### Setup PyPI Tokens

1. **Create Token**:
   - Go to https://pypi.org/manage/account/ (or https://test.pypi.org/manage/account/ for TestPyPI)
   - Create an API token under "API tokens"
   - Copy the token (shown only once!)

2. **Use with Twine** (environment variable):
   ```bash
   export TWINE_USERNAME=__token__
   export TWINE_PASSWORD=pypi-AgEIcHlwaS5vcmc...
   ```

3. **Use ~/.pypirc** (persistent):
   ```ini
   [distutils]
   index-servers =
       pypi
       testpypi

   [pypi]
   repository = https://upload.pypi.org/legacy/
   username = __token__
   password = pypi-AgEIcHlwaS5vcmc...

   [testpypi]
   repository = https://test.pypi.org/legacy/
   username = __token__
   password = pypi-AgEIcHl...
   ```

## uv.lock Management

### About uv.lock

The `uv.lock` file:
- Contains exact pinned versions of all dependencies
- Ensures reproducible builds across environments
- Generated by `uv sync` from `pyproject.toml`
- Should be **committed to git** for reproducibility

### Updating Dependencies

```bash
# Update specific package
uv update package-name

# Update all packages
uv sync --upgrade

# Generate new uv.lock
uv lock
```

## Development Workflow

### Day-to-Day Development

```bash
# 1. Initial setup
make sync
make dev

# 2. Make code changes
# Edit source files

# 3. Run tests
uv run pytest

# 4. Lint and format
uv run ruff check .
uv run ruff format .

# 5. Type check
uv run mypy claude_agent_framework
```

### Adding Dependencies

```bash
# Add production dependency
uv add new-package

# Add development dependency
uv add --group dev new-package

# Sync to update .venv and uv.lock
uv sync
```

### Release Workflow

```bash
# 1. Update version in pyproject.toml
# Edit: version = "X.Y.Z"

# 2. Build package
make build

# 3. Test build locally
uv run python -m twine check dist/*

# 4. Publish to TestPyPI first
make publish-test

# 5. Test installation from TestPyPI
pip install -i https://test.pypi.org/simple/ claude-agent-framework

# 6. Publish to PyPI
make publish-prod

# 7. Create git tag and push
git tag vX.Y.Z
git push origin vX.Y.Z
```

## Troubleshooting

### "uv not found"
```bash
# Install uv
curl -LsSf https://astral.sh/uv/install.sh | sh

# Add to PATH if needed
export PATH="$HOME/.cargo/bin:$PATH"
```

### "Cannot find module in .venv"
```bash
# Resync dependencies
uv sync --all-groups

# Or clear and resync
rm -rf .venv uv.lock
uv sync --all-groups
```

### "Authentication failed" during publish
```bash
# Check PyPI token is valid and not expired
# Verify ~/.pypirc or environment variables are correct
echo $TWINE_PASSWORD  # Should show your token
```

### "Package already exists on PyPI"
You need to update the version in `pyproject.toml`. PyPI doesn't allow re-uploading the same version.

## Makefile Commands Reference

| Command | Purpose |
|---------|---------|
| `make sync` | Sync dependencies with uv |
| `make install` | Install package in editable mode |
| `make dev` | Install with all optional dependencies |
| `make test` | Run tests |
| `make test-cov` | Run tests with coverage |
| `make lint` | Lint code |
| `make format` | Format code |
| `make build` | Build distributions |
| `make build-clean` | Clean and rebuild |
| `make publish-test` | Publish to TestPyPI |
| `make publish-prod` | Publish to PyPI |
| `make check-build` | Check build setup |
| `make clean` | Clean temporary files |

## UV Advantages Over pip/pip-tools

1. **Speed**: Much faster dependency resolution
2. **Reliability**: Deterministic builds with uv.lock
3. **Single tool**: Replaces pip, pip-tools, venv, virtualenv
4. **Built-in tools**: No need for setuptools, wheel, or build
5. **Better error messages**: Clear, actionable error messages
6. **Workspace support**: Can manage monorepos

## Configuration Reference

### pyproject.toml

The `[tool.uv]` section in `pyproject.toml`:

```toml
[tool.uv]
# Dev dependencies (separate from optional dependencies)
dev-dependencies = [
    "pytest>=7.0.0",
    "pytest-asyncio>=0.21.0",
    ...
]

[tool.uv.sources]
# Custom PyPI sources if needed
# Example:
# private-package = { index = "https://private.pypi.org/simple/" }
```

### Build System

The build system uses `hatchling` (compatible with uv):

```toml
[build-system]
requires = ["hatchling"]
build-backend = "hatchling.build"
```

## Further Reading

- [UV Official Documentation](https://docs.astral.sh/uv/)
- [PyPI Help](https://pypi.org/help/)
- [Python Packaging Guide](https://packaging.python.org/)
- [Hatchling Documentation](https://hatch.pypa.io/)
